---
title: "Data Import and Cleanup (study2children)"
author: "Adam Stone, PhD" 
date: '`r format(Sys.Date(), "%m-%d-%Y")`'
output:
  github_document:
    toc: yes
    toc_depth: 2
  html_notebook:
    code_folding: hide
    theme: spacelab
    highlight: tango
    toc: yes
    toc_depth: 2
    toc_float: yes
    df_print: paged
---

```{r eval=FALSE, include=FALSE}
# This is to get all kids' _processed_ AOI data into one single file. Should only run when needed. 
library(tidyverse)
library(feather)

csvpath = "../Child Data/_aoidata/"
files <- dir(path = csvpath, pattern = "_aoidata")
files <- paste(csvpath, files, sep="")
data <- files %>%
  map(read_csv) %>%
  reduce(rbind)
write_feather(data, "childrawdata.feather")
```

# Introduction

Great! At this point, I've run a Matlab script on the children's raw data to tally up all AOI hits for each video/trial they viewed. We start with 67 children. Not all of them go into our analysis. Some are babies, for one thing! Others had bad eye tracking calibration or were too fussy, and so were wholly thrown out. Other kids may have bad trials (e.g., no eye gaze data for more than 75% of the video). We'll go through each at a time. For now here's **all** our data. 

```{r message=FALSE}
# Libraries
library(tidyverse)
library(stringr)
library(cowplot)

# Import data (and fix one participant name)
data <- read_feather("childrawdata.feather") %>%
  mutate(participant = case_when(
    participant == "Ab07ov09_22m" ~ "Ab07ov09_32m",
    TRUE ~ participant
  ))

# Get ages
ages <- read_csv("childrenages.csv")
data <- data %>% left_join(ages, by = "participant")
data %>% select(participant,language,age) %>% distinct() # print data table

# Histogram of ages
data %>% select(participant,language,age) %>% 
  distinct() %>% 
  ggplot(aes(x = age)) + geom_histogram(fill = "royalblue") + ggtitle("Ages in Full Dataset")
```

# Removing Bad/Irrelevant Data

In this order: 

1. "Children" are ages 2 and up so remove all < 2 yrs
1. Keep only those that have "GoodData"

Below are all the children that did *not* have GoodData. 

```{r}
alldata <- data
data <- data %>%
  filter(age > 2.0) %>%
  filter(analysis == "GoodData")

anti_join(alldata, data, by = "participant") %>% 
  select(participant, analysis, age) %>% 
  distinct() %>%
  filter(age > 2.0)
```

All children saw all trials. Now, we need to remove trials where looking data was collected <25% of the video length. I'm importing a table of clip lengths, see below. The videos were shown at 25 FPS so frames / 25 = seconds. 

```{r message=FALSE}
cliplength <- read_csv("cliplengths.csv") %>%
  rename(clip_sec = seconds) %>%
  separate(story, into = c("video", "clipnum")) %>%
  filter(clipnum < 3) %>%
  unite(video, clipnum, col = "story", sep = "_")

cliplength
```

Now let's fold that in. I'm summing up all AOI hits for each video/trial, converting that to seconds (divide by 60, as Tobii's sampling rate is 60 Hz), and throwing out any trials < 25%. 

```{r}
trialcheck <- data %>%
  group_by(participant, condition, trial) %>%
  summarise(secs = sum(hits)/60) %>%
  separate(condition, into = c("story", "clipnum", "direction", "media"), sep = "_") %>%
  unite(story, clipnum, col = "story", sep = "_") %>%
  left_join(cliplength, by = "story") %>%
  mutate(percent = secs / clip_sec)
```



```{r}
# Identify Group 1 story, trial, direction, aoi; add order/repetition/cliplength/percent information
group1 <- group1 %>%
  separate(aoi, into = c("metric", "story", "clip", "direction", "media", "aoi", "math"), 
           sep = "_", convert = TRUE) %>%
  select(-metric, -media, -math) %>%
  unite(story, story:clip, sep = "_") %>%
  left_join(group1order, by = c("story","direction")) %>%
  left_join(cliplength, by = c("story")) %>%
  mutate(percent = ifelse(is.na(sec), NA, sec / cliplength))

# Identify Group 2 story, trial, direction, aoi; add order/repetition/cliplength/percent information
group2 <- group2 %>%
  separate(aoi, into = c("metric", "story", "clip", "direction", "media", "aoi", "math", "suffix"), 
           sep = "_", convert = TRUE) %>%
  select(-metric, -media, -math) %>%
  unite(story, story:clip, sep = "_") %>%
  mutate(rep = case_when(
    story == "Cinderella_1" & is.na(suffix) ~ 1,
    story == "Cinderella_1" & suffix == 1 ~ 2,    
    story == "Cinderella_2" & str_detect(aoi,"3") ~ 1,    
    story == "Cinderella_2" & str_detect(aoi,"2") ~ 2,
    story == "KingMidas_1" & is.na(suffix) ~ 1,
    story == "KingMidas_1" & suffix == 1 ~ 2,
    story == "KingMidas_2" & str_detect(aoi,"3") ~ 1,    
    story == "KingMidas_2" & !str_detect(aoi,"3") ~ 2,
    story == "RedRiding_1" & is.na(suffix) ~ 1,
    story == "RedRiding_1" & suffix == 1 ~ 2,
    story == "RedRiding_2" & is.na(suffix) ~ 1,
    story == "RedRiding_2" & suffix == 1 ~ 2,
    story == "ThreeBears_1" & is.na(suffix) ~ 1,
    story == "ThreeBears_1" & suffix == 1 ~ 2,
    story == "ThreeBears_2" & is.na(suffix) ~ 1,
    story == "ThreeBears_2" & suffix == 1 ~ 2
  )) %>%
  left_join(group2order, by = c("story", "direction", "rep")) %>%
  left_join(cliplength, by = c("story")) %>%
  mutate(sec = as.numeric(sec)) %>%
  mutate(percent = ifelse(is.na(sec), NA, sec / cliplength)) %>% # calculate percentages
  select(-suffix) %>%
  mutate(aoi = ifelse(str_detect(aoi, "\\d"), str_sub(aoi,0,-3), aoi)) # scrub numbers from AOIs

# Combine Groups 1 and 2! 
# data <- bind_rows(group1, group2)
# ggplot(data, aes(x = percent, fill = group)) + geom_histogram(binwidth = .05) + facet_wrap("group")
```

```{r}
ggplot(group2, aes(x = percent)) + geom_histogram() + facet_grid(aoi~story)
```


